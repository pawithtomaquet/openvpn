#cp -rv /usr/share/easy-rsa /etc/openvpn/
#mkdir -p /etc/openvpn/easy-rsa/keys vars
#chmod +x /etc/openvpn/easy-rsa/vars
#cd /etc/openvpn/easy-rsa/



cat << 'EOF' | sudo tee /etc/openvpn/easy-rsa/vars
export KEY_COUNTRY="ES"
export KEY_PROVINCE="BCN"
export KEY_CITY="Barcelona"
export KEY_ORG="blacksamurai.com"
export KEY_EMAIL="blacksamurai.com"
export KEY_OU="SEC"
EOF


./easyrsa init-pki
./easyrsa build-ca

CA pass:
#pass
C-ca-S3C-2020

CN
vpn_001_CA




#Build server key named 
./easyrsa gen-req openvpn_server1 nopass
./easyrsa sign-req server openvpn_server1

Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key:

SAME PASS

#Verify certificate file
sudo openssl verify -CAfile /etc/openvpn/easy-rsa/pki/ca.crt /etc/openvpn/easy-rsa/pki/issued/openvpn_server1.crt
## Output example:
#/etc/openvpn/easy-rsa/pki/issued/openvpn_server1.crt: OK



#Build Client Key using our CA
./easyrsa gen-req client_001 nopass
#Sign in Client Key
./easyrsa sign-req client client_001

#Repeat for all required clients


#Verify client certificate file
sudo openssl verify -CAfile /etc/openvpn/easy-rsa/pki/ca.crt /etc/openvpn/easy-rsa/pki/issued/client1.crt

#Build Diffie-Hellman Key
./easyrsa gen-dh

#Hardening
openvpn --genkey --secret /etc/openvpn/easy-rsa/pki/private/ta.key

#Optional: Generate the CRL Key Certificate Revoking List)
./easyrsa gen-crl

# Copy Certificates Files
cp -v /etc/openvpn/easy-rsa/pki/private/ta.key /etc/openvpn/server/
cp -v /etc/openvpn/easy-rsa/pki/ca.crt /etc/openvpn/server/
cp -v /etc/openvpn/easy-rsa/pki/issued/openvpn_server1.crt /etc/openvpn/server/
cp -v /etc/openvpn/easy-rsa/pki/private/openvpn_server1.key /etc/openvpn/server/


#Copy client Key and Certificate.
cp -v /etc/openvpn/easy-rsa/pki/ca.crt /etc/openvpn/client/

for i in $(ls /etc/openvpn/easy-rsa/pki/issued | grep client); do cp -v /etc/openvpn/easy-rsa/pki/issued/$i /etc/openvpn/client/; done

for i in $(ls /etc/openvpn/easy-rsa/pki/private | grep client); do cp -v /etc/openvpn/easy-rsa/pki/private/$i /etc/openvpn/client/; done

#Copy DH and CRL Key.

cp -v /etc/openvpn/easy-rsa/pki/dh.pem /etc/openvpn/server/
cp -v /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/server/

#Configure OpenVPN, generate config file server.conf:

Dont show blank and empty lines: grep "^[^#;]" /etc/openvpn/server.conf

cat << 'EOF' | tee /etc/openvpn/server.conf
port 443
proto tcp
dev tun
ca /etc/openvpn/server/ca.crt
cert /etc/openvpn/server/openvpn_server1.crt
key /etc/openvpn/server/openvpn_server1.key # This file should be kept secret
dh /etc/openvpn/server/dh.pem
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
#Configuration type server mode gateway
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"
#FI_Configuration type server mode gateway#
client-to-client
keepalive 10 120
tls-auth /etc/openvpn/server/ta.key 0 # This file is secret
cipher AES-256-CBC
comp-lzo
user nobody
group nobody
persist-key
persist-tun
status openvpn-status.log
log-append /var/log/openvpn/server/openvpn.log
verb 3
#Auth with PAM user and password
plugin /usr/lib64/openvpn/plugins/openvpn-plugin-auth-pam.so openvpn
EOF

Si vamos a usar udp hay que comentar en server.conf:
;explicit-exit-notify 1

#Firewalld
sudo firewall-cmd --permanent --add-port=443/tcp

#Masquerade and NAT
sudo firewall-cmd --permanent --add-masquerade
sudo sysctl -w net.ipv4.ip_forward=1



#Debian
iptables -t nat -C POSTROUTING -s "10.8.0.0/8" -o eth0 -j MASQUERADE 
iptables -t nat -A POSTROUTING -s "10.8.0.0/8" -o eth0 -j MASQUERADE





#Persistent ip forward:
cat << 'EOF' | tee -a /etc/sysctl.conf
#ipv4 forward
net.ipv4.ip_forward = 1
EOF


sudo firewall-cmd --reload


mkdir -p /var/log/openvpn/server

sudo systemctl -f enable openvpn@server
sudo systemctl start openvpn@server
sudo systemctl -l status openvpn@server


#PAM Auth
#vi /etc/pam.d/openvpn and add:
cat << 'EOF' | tee /etc/pam.d/openvpn
auth required pam_unix.so shadow nodelay
account required pam_unix.so
EOF


#Optional

Selinux and additional ports
List:
semanage port -l
Add port 4443 to openvpn_port_t
semanage port -a -t openvpn_port_t -p tcp 4443
https://www.certdepot.net/rhel7-use-selinux-port-labelling/



#Client config

Debian 9

warlock@x230:~/configs/openvpn1_vps1_client1$ cat vps1_client1.conf 
#tls-client
resolv-retry infinite
remote 23.254.227.97 443
proto tcp-client
comp-lzo yes
dev tun
dev-type tun
cipher AES-256-CBC
keysize 256
auth SHA1
auth-nocache
tls-auth /home/warlock/configs/openvpn1_vps1_client1/ta.key 1
#verify-x509-name vps1.blacksamurai.com name
#remote-cert-tls server
#ns-cert-type server
reneg-sec 0
persist-tun
persist-key
#tls-remote "ca"
auth-user-pass
client
#pkcs12 fw1-TCP-443-nan.p12
ca /home/warlock/configs/openvpn1_vps1_client1/ca.crt
cert /home/warlock/configs/openvpn1_vps1_client1/client1.crt
key /home/warlock/configs/openvpn1_vps1_client1/client1.key

