

########################################################################33


https://www.howtoforge.com/tutorial/how-to-install-openvpn-server-and-client-with-easy-rsa-3-on-centos-7/

sudo yum update && sudo yum -y install epel-release
sudo yum -y install openvpn easy-rsa

sudo cp /usr/share/doc/openvpn-*/sample/sample-config-files/server.conf /etc/openvpn

sudo mkdir -p /etc/openvpn/easy-rsa/keys
sudo cp -rfv /usr/share/easy-rsa/3/* /etc/openvpn/easy-rsa/


#vi /etc/openvpn/easy-rsa/vars ansd set this settings:

cat << 'EOF' | sudo tee /etc/openvpn/easy-rsa/vars
set_var EASYRSA                 "$PWD"
set_var EASYRSA_PKI             "$EASYRSA/pki"
set_var EASYRSA_DN              "cn_only"
set_var EASYRSA_REQ_COUNTRY     "ES"
set_var EASYRSA_REQ_PROVINCE    "BCN"
set_var EASYRSA_REQ_CITY        "Barcelona"
set_var EASYRSA_REQ_ORG         "xxxlabs"
set_var EASYRSA_REQ_EMAIL       "openvpn@xxxlabs.com"
set_var EASYRSA_REQ_OU          "SECTEC"
set_var EASYRSA_KEY_SIZE        2048
set_var EASYRSA_ALGO            rsa
set_var EASYRSA_CA_EXPIRE       7500
set_var EASYRSA_CERT_EXPIRE     365
set_var EASYRSA_NS_SUPPORT      "no"
set_var EASYRSA_NS_COMMENT      "xxxlabs CERTIFICATE AUTHORITY"
set_var EASYRSA_EXT_DIR         "$EASYRSA/x509-types"
set_var EASYRSA_SSL_CONF        "$EASYRSA/openssl-1.0.cnf"
set_var EASYRSA_DIGEST          "sha256"
EOF

or

cat << 'EOF' | sudo tee /etc/openvpn/easy-rsa/vars
export KEY_COUNTRY="ES"
export KEY_PROVINCE="BCN"
export KEY_CITY="Barcelona"
export KEY_ORG="blacksamurai.com"
export KEY_EMAIL="blacksamurai.com"
export KEY_OU="SEC"
EOF


sudo chmod +x /etc/openvpn/easy-rsa/vars

cd /etc/openvpn/easyrsa
sudo ./easyrsa init-pki
sudo ./easyrsa build-ca


#pass
C-ca-S3C-2019-@

#Build server key named 
sudo ./easyrsa gen-req openvpn_server1 nopass
sudo ./easyrsa sign-req server openvpn_server1

#Verify certificate file
sudo openssl verify -CAfile /etc/openvpn/easy-rsa/pki/ca.crt /etc/openvpn/easy-rsa/pki/issued/openvpn_server1.crt
## Output example:
#/etc/openvpn/easy-rsa/pki/issued/openvpn_server1.crt: OK



#Build Client Key using our CA
sudo ./easyrsa gen-req client1 nopass
#Sign in Client Key
sudo ./easyrsa sign-req client client1

#Repeat for all required clients


#Verify client certificate file
sudo openssl verify -CAfile /etc/openvpn/easy-rsa/pki/ca.crt /etc/openvpn/easy-rsa/pki/issued/client1.crt

#Build Diffie-Hellman Key
sudo ./easyrsa gen-dh

#Hardening
cd /etc/openvpn/easy-rsa/keys
openvpn --genkey --secret ta.key

#Optional: Generate the CRL Key Certificate Revoking List)
sudo ./easyrsa gen-crl

# Copy Certificates Files
sudo cp -v /etc/openvpn/easy-rsa/keys/ta.key /etc/openvpn/server/
sudo cp -v /etc/openvpn/easy-rsa/pki/ca.crt /etc/openvpn/server/
sudo cp -v /etc/openvpn/easy-rsa/pki/issued/openvpn_server1.crt /etc/openvpn/server/
sudo cp -v /etc/openvpn/easy-rsa/pki/private/openvpn_server1.key /etc/openvpn/server/


#Copy client Key and Certificate.
sudo cp -v /etc/openvpn/easy-rsa/pki/ca.crt /etc/openvpn/client/

for i in $(sudo ls  easy-rsa/pki/issued | grep client); do sudo cp -v /etc/openvpn/easy-rsa/pki/issued/$i /etc/openvpn/client/; done

for i in $(sudo ls  easy-rsa/pki/private | grep client); do sudo cp -v /etc/openvpn/easy-rsa/pki/private/$i /etc/openvpn/client/; done

#Copy DH and CRL Key.

sudo cp -v /etc/openvpn/easy-rsa/pki/dh.pem /etc/openvpn/server/
sudo cp -v /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/server/

#Configure OpenVPN, generate config file server.conf:

Dont show blank and empty lines: grep "^[^#;]" /etc/openvpn/server.conf

cat << 'EOF' | sudo tee /etc/openvpn/server.conf
port 443
proto tcp
dev tun
ca /etc/openvpn/server/ca.crt
cert /etc/openvpn/server/openvpn_server1.crt
key /etc/openvpn/server/openvpn_server1.key # This file should be kept secret
dh /etc/openvpn/server/dh.pem
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
#Configuration type server mode gateway
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"
#FI_Configuration type server mode gateway#
client-to-client
keepalive 10 120
tls-auth /etc/openvpn/server/ta.key 0 # This file is secret
cipher AES-256-CBC
comp-lzo
user nobody
group nobody
persist-key
persist-tun
status openvpn-status.log
log-append /var/log/openvpn/server/openvpn.log
verb 3
#Auth with PAM user and password
plugin /usr/lib64/openvpn/plugins/openvpn-plugin-auth-pam.so openvpn
EOF

Si vamos a usar udp hay que comentar en server.conf:
;explicit-exit-notify 1

#Firewalld
sudo firewall-cmd --permanent --add-port=443/tcp

#Masquerade and NAT
sudo firewall-cmd --permanent --add-masquerade
sudo sysctl -w net.ipv4.ip_forward=1

#Persistent ip forward:
cat << 'EOF' | sudo tee -a /etc/sysctl.conf
#ipv4 forward
net.ipv4.ip_forward = 1
EOF


sudo firewall-cmd --reload


mkdir -p /var/log/openvpn/server

sudo systemctl -f enable openvpn@server
sudo systemctl start openvpn@server
sudo systemctl -l status openvpn@server


#PAM Auth
#vi /etc/pam.d/openvpn and add:
cat << 'EOF' | sudo tee /etc/pam.d/openvpn
auth required pam_unix.so shadow nodelay
account required pam_unix.so
EOF


#Optional

Selinux and additional ports
List:
semanage port -l
Add port 4443 to openvpn_port_t
semanage port -a -t openvpn_port_t -p tcp 4443
https://www.certdepot.net/rhel7-use-selinux-port-labelling/



#Client config

Debian 9

warlock@x230:~/configs/openvpn1_vps1_client1$ cat vps1_client1.conf 
#tls-client
resolv-retry infinite
remote 23.254.227.97 443
proto tcp-client
comp-lzo yes
dev tun
dev-type tun
cipher AES-256-CBC
keysize 256
auth SHA1
auth-nocache
tls-auth /home/warlock/configs/openvpn1_vps1_client1/ta.key 1
#verify-x509-name vps1.blacksamurai.com name
#remote-cert-tls server
#ns-cert-type server
reneg-sec 0
persist-tun
persist-key
#tls-remote "ca"
auth-user-pass
client
#pkcs12 fw1-TCP-443-nan.p12
ca /home/warlock/configs/openvpn1_vps1_client1/ca.crt
cert /home/warlock/configs/openvpn1_vps1_client1/client1.crt
key /home/warlock/configs/openvpn1_vps1_client1/client1.key

